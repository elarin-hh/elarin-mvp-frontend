\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{geometry}
\geometry{margin=1in}

\title{Elarin MVP --- Metrica de Qualidade (Slider e Repeticoes)}
\author{Elarin Engineering}
\date{\today}

\begin{document}
\maketitle

\section{Resumo}
Definimos uma metrica unificada de qualidade (0--100) para:
\begin{itemize}
  \item Slider de precisao em tempo real (EMA do score por frame).
  \item Barras de repeticao preenchidas pela qualidade media de cada repeticao.
\end{itemize}
A metrica combina sinais de ML (autoencoder) e heuristica (validator).

\section{Fontes de Sinal}
\begin{itemize}
  \item \textbf{ML}: $q_{\text{ml}}$ vem de \texttt{qualityScore} (0--100) em \texttt{feedback.ml.details}; fallback: \texttt{feedback.ml.confidence} $\times 100$, depois \texttt{feedback.combined.confidence} $\times 100$.
  \item \textbf{Heuristica}: $q_{\text{heur}}$ vem de \texttt{isValid} e lista de \texttt{issues} com severidade.
  \item \textbf{Repeticao}: contador \texttt{validReps} em \texttt{feedback.heuristic.summary} quando disponivel.
\end{itemize}

\section{Penalidades de Heuristica}
Para cada issue com severidade $s$, aplicamos penalidade $p(s)$:
\[
p(s) = \begin{cases}
60, & s = \text{critical}\\
40, & s = \text{high}\\
25, & s = \text{medium}\\
10, & s = \text{low}
\end{cases}
\]
O escore heuristico e entao:
\[
q_{\text{heur}} =
\begin{cases}
95, & \text{se heuristica valida}\\
\max(0, 100 - \sum p(s)), & \text{caso contrario}
\end{cases}
\]

\section{Combinacao ML + Heuristica}
Pesos default: $w_{\text{ml}} = 0.6$, $w_{\text{heur}} = 0.4$.
\[
q_{\text{frame}} =
\begin{cases}
q_{\text{ml}}, & \text{se apenas ML}\\
q_{\text{heur}}, & \text{se apenas heuristica}\\
\text{clamp}\bigl(w_{\text{ml}} q_{\text{ml}} + w_{\text{heur}} q_{\text{heur}},\,0,\,100\bigr), & \text{se ambos}
\end{cases}
\]

\section{Suavizacao Temporal (EMA)}
Usamos uma media exponencial para o slider:
\[
q_{\text{ema}}(t) =
\begin{cases}
q_{\text{frame}}(t), & \text{se } q_{\text{ema}}(t-1) = 0\\
\alpha\, q_{\text{frame}}(t) + (1-\alpha)\, q_{\text{ema}}(t-1), & \text{caso contrario}
\end{cases}
\]
com $\alpha = 0.2$ (ajustavel). Se $q_{\text{frame}}$ for nulo, a EMA nao e atualizada.

\section{Qualidade por Repeticao}
\begin{enumerate}
  \item Acumular $q_{\text{frame}}$ em \texttt{currentRepFrames}.
  \item Quando \texttt{validReps} aumentar:
    \[
    q_{\text{rep}} = \text{media}\bigl( q_{\text{frame}} \text{ da repeticao} \bigr)
    \]
    se nao houver frames, usar o ultimo $q_{\text{frame}}$ conhecido.
  \item Armazenar em \texttt{repScores[repIndex]} com limite de slots.
  \item Limpar o buffer da repeticao corrente.
\end{enumerate}

\subsection{Slots e limite}
O numero de slots e dinamico:
\[
\text{maxSlots} =
\begin{cases}
\min(\texttt{MAX\_REP\_SLOTS\_CAP}, \max(1, \text{target})), & \text{se houver target}\\
\texttt{DEFAULT\_REP\_SLOTS}, & \text{caso contrario}
\end{cases}
\]
com \texttt{DEFAULT\_REP\_SLOTS} = 30 e \texttt{MAX\_REP\_SLOTS\_CAP} = 60.
Se o usuario ultrapassar \texttt{maxSlots}, o ultimo slot e sobrescrito.

\section{Mapeamento de Cores}
Slider e barras usam interpolacao linear entre estes pontos:
\[
\begin{aligned}
0 &\rightarrow \#\text{ef4444}\\
50 &\rightarrow \#\text{f97316}\\
70 &\rightarrow \#\text{fbbf24}\\
85 &\rightarrow \#\text{22c55e}\\
100 &\rightarrow \#\text{22c55e}
\end{aligned}
\]
O gradiente e derivado de ``bands'' (min 85/70/50/0) com mistura de 65\% da cor vizinha.
Slots sem score usam cor neutra \texttt{rgba(255,255,255,0.15)}.

\section{Estados Neutros}
Quando $q_{\text{frame}}$ e nulo, a EMA do slider permanece no valor anterior.
Barras sem score permanecem na cor neutra.

\section{Parametros Ajustaveis}
\begin{itemize}
  \item Pesos $w_{\text{ml}}, w_{\text{heur}}$.
  \item Penalidades $p(s)$ por severidade.
  \item Suavizacao $\alpha$ (EMA).
  \item Pontos de cor e misturas de gradiente.
  \item Limites \texttt{DEFAULT\_REP\_SLOTS} e \texttt{MAX\_REP\_SLOTS\_CAP}.
\end{itemize}

\end{document}
